<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نموذج تقييم الأداء - شركة الروضة</title>
    <link rel="icon" type="image/png" href="favicon.ico">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;800&display=swap" rel="stylesheet">
    
     <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

 <style>
   
    /* --- التنسيقات الأصلية التي أرفقتها (بدون حذف) --- */
    :root {
        --alrowda-green: #1a953e;
        --alrowda-orange: #faa619;
        --alrowda-light-green: #e9f5ec;
        --alrowda-soft-orange: #fff4e5;
        --text-dark: #2d3436;
        --card-shadow: 0 4px 20px rgba(0,0,0,0.08);
    }

    body { 
        background-color: #f4f7f6; 
        font-family: 'Cairo', sans-serif; 
        font-size: 12px; 
        color:black;  
        margin: 0;
        padding: 0;
        /* إضافة اتجاه النص العام */
        direction: rtl; 
            unicode-bidi: embed;

    }

    #authOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, var(--alrowda-green) 0%, #116329 100%); z-index: 9999; display: flex; align-items: center; justify-content: center; }
    .auth-card { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 15px 35px rgba(0,0,0,0.3); width: 350px; text-align: center; border-top: 6px solid var(--alrowda-orange); }

    /* تعديل حاوية A4 لتصبح صارمة بصفحة واحدة */
    .a4-container { 
        width: 210mm; 
        height: auto; /* تثبيت الارتفاع لضمان صفحة واحدة */
        background: white; 
        padding: 3mm; 
        box-shadow: var(--card-shadow); 
        border-radius: 15px; 
        border: 3px solid #f1f1ef; 
        flex-direction: column; 
        box-sizing: border-box; /* لضمان حساب الهوامش ضمن الحجم */
        overflow: hidden; /* يمنع امتداد المحتوى لصفحة ثانية */
    }

    .header-brand { border-bottom: 3px solid var(--alrowda-orange); margin-bottom: 15px; padding-bottom: 10px; }
    .title-text h5 { color: var(--alrowda-green); font-weight: 800; margin: 0; }
    
    table { width: 100%; margin-bottom: 15px !important; border-radius: 8px; overflow: hidden; border-collapse: collapse; }
    th { background-color: var(--alrowda-green) !important; color: white !important; font-weight: 700; padding: 8px !important; }
    .bg-light-row { background-color: var(--alrowda-light-green) !important; font-weight: 700; color: var(--alrowda-green); }
    .max-score-col { background-color: var(--alrowda-soft-orange) !important; color: #d35400; font-weight: 700; }

    .score-input { width: 45px; text-align: center; border: 1px solid #ddd; border-radius: 4px; font-weight: bold; height: 25px; }

    .suggestions-container { position: relative; width: 100%; }
    #suggestionsList {
        position: absolute; top: 100%; left: 0; right: 0;
        background: #ffffff; border: 1px solid #dce0e4; border-radius: 0 0 12px 12px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.25); z-index: 99999; display: none;
        max-height: 280px; overflow-y: auto; padding: 5px 0;
    }

    .suggestion-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 18px; cursor: pointer; border-bottom: 1px solid #f1f1f1; transition: background 0.2s ease; }
    .suggestion-item:last-child { border-bottom: none; }
    .suggestion-item:hover { background-color: #f0f9f2; }
    .item-content { display: flex; align-items: center; gap: 12px; }
    .item-content i { color: #1a953e; font-size: 1.2rem; }
    .emp-name-text { font-weight: 700; font-size: 14px; color: #0f0f0f; }
    .emp-id-badge { background: #f1f2f6; color: #0f0f0f; padding: 2px 8px; border-radius: 6px; font-size: 11px; font-family: monospace; font-weight: 600; }

    #suggestionsList::-webkit-scrollbar { width: 7px; }
    #suggestionsList::-webkit-scrollbar-track { background: #e8f7ec; border-radius: 10px; }
    #suggestionsList::-webkit-scrollbar-thumb { background: var(--alrowda-orange); border-radius: 10px; }
    #suggestionsList::-webkit-scrollbar-thumb:hover { background: #e69510; }

    main, .table, .card { overflow: visible !important; }

    /* --- التعديلات الجديدة المطلوبة --- */

    /* 1. ضبط اتجاه الحقول في الجداول لتكون (العنوان يمين - القيمة يسار) */
    .info-table td {
        text-align: right !important;
        direction: rtl !important;
    }
/* 1. التنسيق العام للمستند (للتأكد من الـ RTL في كل الأحوال) */



/* 3. تنسيقات العرض على الشاشة (للمحافظة على شكل الجداول) */
table { 
    direction: rtl; 
    width: 100%; 
    border-collapse: collapse; 
}
/* فرض RTL بشكل دائم أثناء التحويل */
.rtl {
    direction: rtl !important;
    text-align: right !important;
     
}

.rtl * {
    direction: rtl !important;
    
    text-align: right !important;
}
</style>
</head>
<body>

<div id="authOverlay">
    <div class="auth-card">
        <img src="logo.jpeg" alt="Logo" style="width: 80px; margin-bottom: 15px;">
        
        <h5 id="authTitle" class="fw-bold mb-3" style="color: var(--alrowda-green)">دخول المسؤول المباشر</h5>

        <div id="step1">
            <input type="password" id="managerIDInput" class="form-control text-center mb-3" placeholder="أدخل الرقم الوظيفي" onkeypress="if(event.key==='Enter') proceedToCode()">
            <button onclick="proceedToCode()" id="nextBtn" class="btn btn-success w-100 fw-bold">التالي</button>
        </div>

        <div id="step2" style="display:none;">
            <input type="password" id="managerCodeInput" class="form-control text-center mb-3" placeholder="أدخل كود التحقق الخاص بك" onkeypress="if(event.key==='Enter') verifyFinalAuth()">
            <button onclick="verifyFinalAuth()" id="loginBtn" class="btn btn-primary w-100 fw-bold" style="background-color: var(--alrowda-green); border:none;">دخول للتقييم</button>
<button onclick="backToStep1()" class="btn btn-link btn-sm mt-2 text-decoration-none text-black">
    <i class="bi bi-arrow-right-circle me-1"></i> رجوع
</button>
        </div>

        <div id="errorMsg" class="text-danger mt-2 small" style="display:none;">البيانات المدخلة غير صحيحة!</div>
    </div>
</div>
<!-- <div id="modelTabs" class="d-flex justify-content-center mb-3 no-print" style="display:none !important;">
    <button type="button" id="tabSpecialized" class="btn btn-outline-primary mx-2 active" onclick="switchModel('تخصصية')">
        <i class="fas fa-user-gear me-1"></i> نموذج الوظائف التخصصية
    </button>
    <button type="button" id="tabSupervisory" class="btn btn-outline-primary mx-2" onclick="switchModel('إشرافية')">
        <i class="fas fa-user-tie me-1"></i> نموذج الوظائف الإشرافية
    </button>
</div> -->
<div id="mainContent" class="a4-container container" style="display:none;">
   <div class="header-brand d-flex justify-content-between align-items-center">
        <div class="title-text"><h5 id="dynamicTitle">نموذج تقييم الأداء</h5></div>
        <img src="logo.jpeg" alt="Logo" style="height: 60px;">
    </div>

    <main style="position: relative; background-color: #ffffff;  border-radius: 2%;">
        <table class="table table-bordered align-middle rtl">
            <tr>
                <td class="bg-light-row " width="15%">اسم الموظف</td>
                <td width="35%">
                    <div class="suggestions-container">
                        <input type="text" id="empName" class="form-control form-control-sm border-0" placeholder="ابدأ بكتابة الاسم..." oninput="handleSearch(this.value)" autocomplete="off">
                        <div id="suggestionsList"></div>
                    </div>
                </td>
                <td class="bg-light-row" width="15%">رقم الموظف</td>
                <td width="35%"><input type="text" id="empID" class="form-control form-control-sm border-0" readonly></td>
            </tr>
            <tr>
                <td class="bg-light-row">الوظيفة</td>
                <td><input type="text" id="jobTitle" class="form-control form-control-sm border-0" readonly></td>
                <td class="bg-light-row">الإدارة</td>
                <td><input type="text" id="dept" class="form-control form-control-sm border-0" readonly></td>
            </tr>
        </table>

        <table class="table table-bordered text-center">
            <thead>
                <tr>
                    <th>م</th><th>عناصر التقييم</th><th>الأعلى</th><th>الدرجة</th>
                    <th>م</th><th>عناصر التقييم</th><th>الأعلى</th><th>الدرجة</th>
                </tr>
            </thead>
            <tbody id="evalBody"></tbody>
            <tfoot>
                <tr>
                    <td colspan="6" class="total-banner text-center bg-light-row">النتيجة النهائية المكتسبة:</td>
                    <td colspan="2" class="total-banner text-center"><span id="total">0</span> / 100</td>
                </tr>
            </tfoot>
        </table>

        <table class="table table-bordered text-center">
            <thead><tr><th width="33%">نقاط القوة</th><th width="33%">نقاط الضعف</th><th>التوصيات والمقترحات</th></tr></thead>
            <tbody>
                <tr class="rtl">
                    <td><textarea id="strengthsText" class="form-control" rows="2"></textarea></td>
                    <td><textarea id="weaknessText" class="form-control" rows="2"></textarea></td>
                    <td><textarea id="recText" class="form-control" rows="2"></textarea></td>
                </tr>
            </tbody>
        </table>

        <table class="table table-bordered text-center">
            <thead><tr><th width="33%">توقيع  بمصادقة الموظف</th><th width="33%">توقيع المسئول المباشر</th><th> اعتماد الموارد البشرية</th></tr></thead>
            <tbody>
                <tr class="text-center">
                    <td class="sig-cell"> ------------------</td>
                    <td class="sig-cell"><span id="managerNameDisplay" style="font-weight:700;"></span><br> ------------------</td>
                    <td class="sig-cell"> ------------------</td>
                </tr>
                </tbody>
        </table>
       
        <div id="docReferenceCode" class="text-muted small text-black fw-bold text-black" 
     style="position:absolute; bottom:-3px; left:10px;">
    REC-QF-20-30/Rev02
</div>
    </main>
 
    <div class="mt-3 text-center no-print">
        <button id="sendBtn" class="btn btn-success no-print-btn" onclick="submitData()">
            <i class="fas fa-save me-2"></i> إرسال وحفظ التقييم
        </button>
    </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxdCT7V_SUKCjjWblOFrBcErHS1ENK3ugVbePaNG9VMkz0UUms_FqLr34wWClrpCiyo/exec'; 
    let currentManagerID = "";
    let currentManagerName = "";
    let currentManagerRole = ""; 
    let allEmployees = []; 
    let sessionToken = "";
    let tempManagerID = ""; 

    const specializedItems = [
        {id: 1,  txt: "مستوى تحقيقه للأهداف المنشودة", max: 4, id2: 12, txt2: "مستوى معرفته بتفاصيل مهام وظيفته", max2: 4},
        {id: 2,  txt: "درجة الاعتماد عليه وتحمل المسئولية", max: 4, id2: 13, txt2: "مستوى خبرته في أداء مهام وظيفته", max2: 4},
        {id: 3,  txt: "مستوى تعاونه مع زملائه في العمل", max: 4, id2: 14, txt2: "السرعة في إنجاز الأعمال المكلف بها", max2: 4},
        {id: 4,  txt: "مستوى تعاونه مع رؤسائه في العمل", max: 4, id2: 15, txt2: "الدقة في أداء الأعمال المكلف بها", max2: 4},
        {id: 5,  txt: "مستوى تعاونه مع الآخرين", max: 4, id2: 16, txt2: "إمكانية تحمله لمهام ومسؤوليات أعلى", max2: 4},
        {id: 6,  txt: "البديهة وحسن التصرف", max: 4, id2: 17, txt2: "الحرص على ترتيب وتنظيم ونظافة مكان عمله", max2: 4},
        {id: 7,  txt: "مدى قدرته على تطوير وابتكار أساليب العمل", max: 4, id2: 18, txt2: "مدى التزامه بأوقات الدوام الرسمي", max2: 4},
        {id: 8,  txt: "رغبته في التعلم والتطوير الذاتي", max: 4, id2: 19, txt2: "مدى التزامه بمعايير وأخلاقيات العمل", max2: 4},
        {id: 9,  txt: "مدى احترامه لأنظمة وتعليمات العمل", max: 4, id2: 20, txt2: "مدى اهتمامه بحسن مظهره ونظافته", max2: 4},
        {id: 10, txt: "العمل بروح الفريق", max: 4, id2: 21, txt2: "المحافظة على أدوات العمل", max2: 4},
        {id: 11, txt: "التأخير والغياب", max: 10, id2: 22, txt2: "المخالفات الوظيفية", max2: 10},
    ];

    const supervisoryItems = [
        {id: 1,  txt: "القدرة على القيادة والتوجيه", max: 4, id2: 12, txt2: "التخطيط وتنظيم العمل", max2: 4},
        {id: 2,  txt: "اتخاذ القرارات وحل المشكلات", max: 4, id2: 13, txt2: "تطوير ورفع كفاءة المرؤوسين", max2: 4},
        {id: 3,  txt: "المتابعة والرقابة على الأداء", max: 4, id2: 14, txt2: "القدرة على التفويض الفعال", max2: 4},
        {id: 4,  txt: "إدارة الوقت وتحديد الأولويات", max: 4, id2: 15, txt2: "تحمل المسؤولية وضغط العمل", max2: 4},
        {id: 5,  txt: "المساهمة في الأهداف الاستراتيجية", max: 4, id2: 16, txt2: "الالتزام بالأنظمة واللوائح", max2: 4},
        {id: 6,  txt: "الابتكار وتطوير أساليب العمل", max: 4, id2: 17, txt2: "مهارات التواصل الفعال", max2: 4},
        {id: 7,  txt: "العدالة والموضوعية مع المرؤوسين", max: 4, id2: 18, txt2: "سرية المعلومات والأمانة", max2: 4},
        {id: 8,  txt: "تحقيق النتائج المستهدفة للقسم", max: 4, id2: 19, txt2: "إعداد التقارير الفنية بدقة", max2: 4},
        {id: 9,  txt: "العمل بروح الفريق الواحد", max: 4, id2: 20, txt2: "تطوير الذات والتعلم المستمر", max2: 4},
        {id: 10, txt: "القدوة الحسنة للموظفين", max: 4, id2: 21, txt2: "المحافظة على موارد العمل", max2: 4},
        {id: 11, txt: "الالتزام بالدوام الرسمي", max: 10, id2: 22, txt2: "المخالفات الإدارية", max2: 10},
    ];

    document.addEventListener('DOMContentLoaded', function() {
        const loginInput = document.getElementById('managerIDInput');
        if (loginInput) loginInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') proceedToCode(); });

        const codeInput = document.getElementById('managerCodeInput');
        if (codeInput) codeInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') verifyFinalAuth(); });
    });

    // دالة تبديل النماذج عبر التبويبات
    function switchModel(type) {
        renderTable(type);
        // تحديث شكل الأزرار
        const tabSpec = document.getElementById('tabSpecialized');
        const tabSup = document.getElementById('tabSupervisory');
        if(tabSpec && tabSup) {
            tabSpec.classList.toggle('active', type === 'تخصصية');
            tabSup.classList.toggle('active', type === 'إشرافية');
        }
        sum(); // إعادة حساب المجموع للتأكد
    }

    // بناء الجدول ديناميكياً وتحديث كود النموذج
    function renderTable(role) {
        const body = document.getElementById('evalBody');
        const title = document.getElementById('dynamicTitle');
        const docCode = document.getElementById('docReferenceCode'); 

        if(!body || !title) return;
        
        body.innerHTML = "";
        
        let items;
        if (role === "Executive" || role === "إشرافية") {
            items = supervisoryItems;
            title.innerText = "نموذج تقييم أداء الوظائف الإشرافية";
            if(docCode) {
                docCode.innerText = "REC-QF-20-29/Rev02";
                docCode.style.setProperty('color', '#000', 'important');
                docCode.style.fontWeight = "900";
            }
        } else {
            items = specializedItems;
            title.innerText = "نموذج تقييم أداء الوظائف التخصصية";
            if(docCode) {
                docCode.innerText = "REC-QF-20-30/Rev02";
                docCode.style.setProperty('color', '#000', 'important');
                docCode.style.fontWeight = "900";
            }
        }

        items.forEach(item => {
            body.innerHTML += `
                <tr>
                    <td style="background-color:#faa619; color:white; text-align:center;">${item.id}</td>
                    <td class="text-start ps-2">${item.txt}</td>
                    <td class="max-score-col" style="text-align:center;">${item.max}</td>
                    <td style="text-align:center;"><input type="text" class="score-input" inputmode="numeric" onkeydown="return allowOnlyPositiveNumbers(event)" oninput="validateScore(this, ${item.max})"></td>
                    <td style="background-color:#faa619; color:white; text-align:center;">${item.id2}</td>
                    <td class="text-start ps-2">${item.txt2}</td>
                    <td class="max-score-col" style="text-align:center;">${item.max2}</td>
                    <td style="text-align:center;"><input type="text" class="score-input" inputmode="numeric" onkeydown="return allowOnlyPositiveNumbers(event)" oninput="validateScore(this, ${item.max2})"></td>
                </tr>`;
        });
    }

    function proceedToCode() {
        const idInput = document.getElementById('managerIDInput');
        if (!idInput.value) { showAuthError("يرجى إدخال الرقم الوظيفي"); return; }
        
        tempManagerID = idInput.value;
        document.getElementById('step1').style.display = 'none';
        document.getElementById('step2').style.display = 'block';
        document.getElementById('authTitle').innerText = "تأكيد كود المدير";
        document.getElementById('errorMsg').style.display = 'none';
    }

    function verifyFinalAuth() {
        const codeInput = document.getElementById('managerCodeInput');
        const btn = document.getElementById('loginBtn');
        if (!codeInput.value) { showAuthError("يرجى إدخال كود المدير"); return; }

        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري التحقق...';
        btn.disabled = true;

        fetch(`${SCRIPT_URL}?action=checkManager&id=${tempManagerID}&code=${codeInput.value}`)
            .then(res => res.json())
            .then(data => {
                if (data.valid) {
                    currentManagerID = tempManagerID;
                    currentManagerName = data.managerName;
                    currentManagerRole = data.role; 
                    sessionToken = data.token;

                    document.getElementById('managerNameDisplay').innerText = currentManagerName;
                    document.getElementById('authOverlay').style.display = 'none';
                    document.getElementById('mainContent').style.display = 'flex';
                    
                    // إظهار التبويبات فقط للمدير التنفيذي
                    const tabs = document.getElementById('modelTabs');
                    if (tabs) {
                        tabs.style.display = (currentManagerRole === "Executive") ? "flex" : "none";
                    }

                    renderTable(currentManagerRole); 
                    fetchEmployees(); 
                } else {
                    showAuthError("عفواً، الكود غير صحيح!");
                    btn.innerHTML = 'دخول للتقييم';
                    btn.disabled = false;
                }
            })
            .catch(err => {
                showAuthError("خطأ في الاتصال بالسيرفر");
                btn.disabled = false;
            });
    }

    function handleSearch(query) {
        const list = document.getElementById('suggestionsList');
        if (!list) return;
        list.innerHTML = '';
        if (!query || query.length < 1) { list.style.display = 'none'; return; }

        const q = query.trim().toLowerCase();
        
        const filtered = allEmployees.filter(emp => {
            const matchesQuery = emp.name.toLowerCase().includes(q) || emp.id.toString().startsWith(q);
            if (currentManagerRole === "Executive") {
                return matchesQuery;
            } else {
                return matchesQuery && emp.category === "تخصصية";
            }
        });

        if (filtered.length === 0) { list.style.display = 'none'; return; }

        list.innerHTML = filtered.map(emp => `
            <div class="suggestion-item" onclick="selectEmployee('${emp.name}','${emp.id}','${emp.job}','${emp.dept}','${emp.category}')">
                <div class="item-content"><i class="fas fa-user"></i> <span class="emp-name-text">${emp.name}</span></div>
                <span class="emp-id-badge">${emp.category} | ${emp.id}</span>
            </div>
        `).join('');
        list.style.display = 'block';
    }

    function fetchEmployees() {
        fetch(`${SCRIPT_URL}?action=getEmployees`)
            .then(res => res.json())
            .then(data => { allEmployees = data; })
            .catch(err => console.error("خطأ:", err));
    }

    function selectEmployee(name, id, job, dept, category) {
        document.getElementById('empID').value = id;
        document.getElementById('empName').value = name;
        document.getElementById('jobTitle').value = job;
        document.getElementById('dept').value = dept;
        document.getElementById('suggestionsList').style.display = 'none';
        
        // عند اختيار موظف، نقوم بتبديل التبويب والجدول تلقائياً
        if (category) {
            switchModel(category);
        }
    }

    function allowOnlyPositiveNumbers(e) {
        if (['-', '+', 'e', 'E', 'ArrowUp', 'ArrowDown'].includes(e.key)) return false;
        return true;
    }

    function validateScore(input, max) {
        input.value = input.value.replace(/[^0-9.]/g, '');
        const parts = input.value.split('.');
        if (parts.length > 2) input.value = parts[0] + '.' + parts[1];
        if (parts.length === 2 && parts[1].length > 2) input.value = parts[0] + '.' + parts[1].substring(0, 2);
        const val = parseFloat(input.value);
        if (!isNaN(val) && val > max) input.value = max;
        sum();
    }

    function sum() {
        let total = 0;
        document.querySelectorAll('.score-input').forEach(i => total += (Number(i.value) || 0));
        document.getElementById('total').innerText = total.toFixed(2).replace(/\.00$/, '');
    }

    function submitData() {
        if (!document.getElementById('empName').value) { alert("اختر موظفاً أولاً"); return; }
        
        let allScoresFilled = true;
        document.querySelectorAll('.score-input').forEach(input => {
            if (input.value === '' || isNaN(input.value)) {
                allScoresFilled = false;
                input.style.border = "2px solid red";
            } else {
                input.style.border = "1px solid #ddd";
            }
        });

        if (!allScoresFilled) { alert("يرجى تعبئة جميع بنود التقييم"); return; }

        const strengths = document.getElementById('strengthsText').value.trim();
        const weaknesses = document.getElementById('weaknessText').value.trim();
        const recommendations = document.getElementById('recText').value.trim();

        if (!strengths || !weaknesses || !recommendations) { alert("يرجى تعبئة جميع الملاحظات الختامية"); return; }

        const btn = document.getElementById('sendBtn');
        btn.disabled = true;
        btn.innerHTML = "جاري الحفظ...";

        const scores = [];
        document.querySelectorAll('.score-input').forEach(i => scores.push(Number(i.value)));

        const payload = {
            token: sessionToken,
            managerID: currentManagerID,
            managerName: currentManagerName,
            empName: document.getElementById('empName').value,
            empID: document.getElementById('empID').value,
            jobTitle: document.getElementById('jobTitle').value,
            dept: document.getElementById('dept').value,
            scores: scores,
            total: document.getElementById('total').innerText,
            strengths: strengths,
            weaknesses: weaknesses,
            recommendations: recommendations
        };

        fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify(payload)
        })
        .then(() => {
            alert("تم حفظ التقييم بنجاح!");
            downloadPDF();
            setTimeout(() => { resetForm(); }, 2000);
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = `<i class="fas fa-save me-2"></i> إرسال وحفظ التقييم`;
        });
    }

    function downloadPDF() {
        const element = document.getElementById('mainContent');
        const empName = document.getElementById('empName').value.trim() || 'تقييم_موظف';
        
        element.classList.add('pdf-print-mode');
        element.style.direction = 'rtl';
        // إخفاء التبويبات وأي أزرار عند الطباعة
        const buttonsToHide = element.querySelectorAll('button, .no-print, .submit-btn, #suggestionsList, #modelTabs');
        buttonsToHide.forEach(btn => btn.style.display = 'none');

        const opt = {
            filename: empName + '.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { 
                scale: 2, 
                useCORS: true, 
                letterRendering: true,
                scrollX: 0,
                scrollY: 0
            },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };

        html2pdf().set(opt).from(element).save().then(() => {
            element.classList.remove('pdf-print-mode');
            buttonsToHide.forEach(btn => btn.style.display = '');
            // إعادة إخفاء التبويبات إذا لم يكن المدير تنفيذي
            if (currentManagerRole !== "Executive") {
                document.getElementById('modelTabs').style.display = 'none';
            }
        });
    }

    function resetForm() {
        document.getElementById('empName').value = '';
        document.getElementById('empID').value = '';
        document.getElementById('jobTitle').value = '';
        document.getElementById('dept').value = '';
        document.getElementById('total').innerText = '0';
        document.getElementById('strengthsText').value = '';
        document.getElementById('weaknessText').value = '';
        document.getElementById('recText').value = '';
        document.querySelectorAll('.score-input').forEach(i => i.value = '');
    }

    function backToStep1() {
        document.getElementById('step1').style.display = 'block';
        document.getElementById('step2').style.display = 'none';
        document.getElementById('authTitle').innerText = "دخول المسؤول المباشر";
        document.getElementById('errorMsg').style.display = 'none';
    }

    function showAuthError(msg) {
        const err = document.getElementById('errorMsg');
        err.innerText = msg;
        err.style.display = 'block';
    }
</script>
</body>
</html>
